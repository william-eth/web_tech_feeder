<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>每週技術新知摘要</title>
  <style>
    body, table, td, p, a, li { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
    table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-collapse: separate; }
    img { -ms-interpolation-mode: bicubic; border: 0; outline: none; text-decoration: none; }
    p { margin: 0; }
    a { text-decoration: none; }
    .ExternalClass { width: 100%; }
    .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass td, .ExternalClass div { line-height: 100%; }
    a[x-apple-data-detectors] { color: inherit !important; text-decoration: none !important; }
  </style>
  <!--[if !mso]><!-->
  <style>
    .enhanced-shell {
      border: 1px solid #dbe4ee !important;
      border-radius: 12px !important;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.14) !important;
    }
    .enhanced-header {
      border-radius: 12px 12px 0 0 !important;
      background: linear-gradient(180deg, #0b1736 0%, #0f172a 100%) !important;
    }
    .enhanced-content {
      border-radius: 0 0 12px 12px !important;
      padding-bottom: 6px !important;
    }
    .enhanced-item {
      border-radius: 8px !important;
      box-shadow: 0 1px 0 rgba(15, 23, 42, 0.06) !important;
    }
  </style>
  <!--<![endif]-->
  <!--[if mso]>
  <style>
    .enhanced-shell,
    .enhanced-header,
    .enhanced-content,
    .enhanced-item {
      border-radius: 0 !important;
      box-shadow: none !important;
      overflow: visible !important;
    }
  </style>
  <![endif]-->
  <!--[if mso]>
  <noscript>
    <xml>
      <o:OfficeDocumentSettings>
        <o:PixelsPerInch>96</o:PixelsPerInch>
      </o:OfficeDocumentSettings>
    </xml>
  </noscript>
  <![endif]-->
</head>
<body style="<%= page_body_style %>">
  <center style="width:100%;background-color:#f1f5f9;">
    <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" style="width:100%;background-color:#f1f5f9;">
      <tr>
        <td align="center" style="padding:16px;">
          <!--[if mso]>
          <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="640">
            <tr>
              <td>
          <![endif]-->
          <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" class="enhanced-shell" style="width:100%;max-width:640px;margin:0 auto;border-collapse:separate;">
            <tr>
              <td class="enhanced-header" style="<%= header_style %>">
                <p style="<%= header_title_style %>">每週技術新知摘要</p>
                <p class="date-range" style="<%= date_range_style %>"><%= date_range %></p>
                <span class="item-count" style="<%= item_count_style %>">共 <%= total_items %> 則</span>
              </td>
            </tr>
            <tr>
              <td class="enhanced-content" style="<%= content_style %>">
                <% categories = [
                  { key: :frontend, tag: "FE", fallback_title: "前端技術動態" },
                  { key: :backend, tag: "BE", fallback_title: "後端技術動態" },
                  { key: :devops, tag: "OPS", fallback_title: "DevOps 相關資訊" }
                ] %>
                <% visible_categories = categories.select { |cat| digest_data[cat[:key]] } %>

                <% visible_categories.each_with_index do |cat, idx| %>
                  <% section = digest_data[cat[:key]] %>
                  <% release_items = section[:release_items] || [] %>
                  <% other_items = section[:other_items] || [] %>
                  <% item_count = release_items.size + other_items.size %>
                  <% item_count = (section[:items]&.size || 0) if item_count.zero? %>
                  <% section_style_value = section_style.dup %>
                  <% section_style_value << "border-bottom:none;" if idx == visible_categories.length - 1 %>
                  <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" style="<%= section_style_value %>;border-collapse:separate;">
                    <tr>
                      <td>
                        <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" style="<%= section_header_style %>;border-collapse:separate;">
                          <tr>
                            <td style="vertical-align:middle;">
                              <span class="section-tag" style="<%= section_tag_style(cat[:key]) %>"><%= cat[:tag] %></span>
                              <span class="section-title" style="<%= section_title_style %>"><%= section[:section_title] || cat[:fallback_title] %></span>
                              <span class="section-count" style="<%= section_count_style %>">· <%= item_count %></span>
                            </td>
                          </tr>
                        </table>

                        <% if item_count.zero? %>
                          <p class="empty-state" style="<%= empty_state_style %>">本週暫無相關更新</p>
                        <% else %>
                          <% [[ "版本釋出", release_items, true ], [ "其他動態", other_items, release_items.any? ]].each do |subsection_title, items, show_title| %>
                            <% next if items.empty? %>
                            <% if show_title %>
                              <p class="subsection-title" style="<%= subsection_title_style %>"><%= subsection_title %></p>
                            <% end %>
                            <% items.each_with_index do |item, item_idx| %>
                              <% importance = (item[:importance] || "medium").downcase %>
                              <% fw = item[:framework_or_package].to_s.strip %>
                              <% show_fw_badge = !fw.empty? && subsection_title == "其他動態" %>
                              <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" class="enhanced-item" style="<%= item_style(importance) %>;border-collapse:separate;">
                                <tr>
                                  <td>
                                    <p class="item-title" style="<%= item_title_style %>">
                                      <% if show_fw_badge %><span class="framework-badge" style="<%= framework_badge_style %>"><%= fw %></span><% end %>
                                      <% if item[:source_url] && !item[:source_url].to_s.empty? %>
                                        <a href="<%= item[:source_url] %>" style="<%= item_title_link_style %>"><%= truncate_text(item[:title].to_s, 180) %></a>
                                      <% else %>
                                        <%= truncate_text(item[:title].to_s, 180) %>
                                      <% end %>
                                      <span class="importance-badge badge-<%= importance %>" style="<%= importance_badge_style(importance) %>"><%= importance_label(importance) %></span>
                                    </p>

                                    <div class="item-summary" style="<%= item_summary_style %>">
                                      <% summary_parts(item[:summary]).each do |label, content| %>
                                        <% next if content.to_s.strip.empty? %>
                                        <div class="summary-part" style="<%= summary_part_style %>">
                                          <% if label %>
                                            <div class="summary-part-label" style="<%= summary_part_label_style %>"><%= label %></div>
                                            <div class="summary-part-body" style="<%= summary_part_body_style %>"><%= format_summary_content(truncate_text(content.to_s, 1600)) %></div>
                                          <% else %>
                                            <div class="summary-part-body" style="<%= summary_part_body_style %>"><%= format_summary_content(truncate_text(content.to_s, 1600)) %></div>
                                          <% end %>
                                        </div>
                                      <% end %>
                                    </div>

                                    <p class="item-source" style="<%= item_source_style %>">
                                      <% if item[:source_url] && !item[:source_url].to_s.empty? %>
                                        <a href="<%= item[:source_url] %>" style="<%= item_source_link_style %>"><%= item[:source_name] || shorten_url(item[:source_url].to_s) %></a>
                                      <% else %>
                                        <%= item[:source_name] || "Unknown" %>
                                      <% end %>
                                    </p>
                                  </td>
                                </tr>
                              </table>
                              <% unless item_idx == items.length - 1 %>
                                <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" style="border-collapse:separate;">
                                  <tr><td height="12" style="height:12px;line-height:12px;font-size:0;">&nbsp;</td></tr>
                                </table>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      </td>
                    </tr>
                  </table>
                <% end %>
              </td>
            </tr>
            <tr>
              <td style="<%= footer_style %>">
                <a href="https://github.com/william-eth/web_tech_feeder" style="<%= footer_link_style %>">Web Tech Feeder</a> · AI-powered digest
              </td>
            </tr>
          </table>
          <!--[if mso]>
              </td>
            </tr>
          </table>
          <![endif]-->
        </td>
      </tr>
    </table>
  </center>
</body>
</html>
